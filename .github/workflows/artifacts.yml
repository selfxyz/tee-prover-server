name: TEE Docker Build
on:
  workflow_call:
    inputs:
      environment:
        description: The GitHub Actions environment
        required: true
        type: string
      tag:
        description: The tag
        required: true
        type: string

jobs:
  prod:
    permissions:
      contents: read
      id-token: write
    runs-on: [self-hosted-gha]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GAR_REGISTRY: us-docker.pkg.dev
          ARTIFACT_REPOSITORY: ${{ secrets.GCP_ARTIFACT_REPOSITORY }}
          ARTIFACT_URL: ${{ env.GAR_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPOSITORY }}

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: access_token
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }} # full resource path
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: ">= 363.0.0"
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_REGISTRY }} --quiet

      - name: Login to AWS
        run: |
          aws --profile default configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws --profile default configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # - name: Download and unpack artifact
      #   run: |
      #     curl -L \
      #       -H "Accept: application/vnd.github+json" \
      #       -H "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" \
      #       -H "X-GitHub-Api-Version: 2022-11-28" \
      #       -o artifact.zip \
      #       https://api.github.com/repos/selfxyz/self/actions/artifacts/3424161964/zip

      # - name: Sort circuits
      #   run: |
      #     unzip artifact.zip -d ./circuits/
      #     chmod +x sort_circuits.sh
      #     ./sort_circuits.sh

      - name: Install aws cli
        run: |
          if ! command -v aws &> /dev/null; then
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
          fi

      # - name: Download and unpack zkeys
      #   run: |
      #     rm -rf zkeys
      #     chmod +x download_zkeys.sh && ./download_zkeys.sh
      #     mkdir zkeys
      #     mv *.zkey zkeys/

      # - name: Reformat zkeys
      #   run: |
      #     mkdir -p zkeys/register zkeys/disclose zkeys/dsc
      #     mv zkeys/register_* zkeys/register/
      #     mv zkeys/vc_and_disclose*.zkey zkeys/disclose/
      #     mv zkeys/dsc_* zkeys/dsc/
      #     chmod +x sort_zkeys.sh
      #     ./sort_zkeys.sh

      - name: Init submodules
        run: |
          git submodule update --init
          cd rapidsnark && git submodule update --init && cd ..

      - name: Build docker enclave images
        run: |
          chmod +x ./build_docker.sh
          ./build_docker.sh ${{ env.ARTIFACT_URL }} ${{ inputs.tag }}

      - name: Cleanup zkeys
        run: rm -rf zkeys*

      - name: Push images
        run: |
          chmod +x push_docker.sh
          ./push_docker.sh ${{ env.ARTIFACT_URL }} ${{ inputs.tag }}
